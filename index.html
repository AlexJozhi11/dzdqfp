<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>槟城金刚山牌位系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .fade-in {
        animation: fadeIn 0.4s ease-out;
    }

    .loading-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1em;
        height: 1em;
        vertical-align: middle;
        animation: spin 0.8s linear infinite;
    }

    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        min-width: 200px;
        max-width: 280px;
        background-color: #4B5563;
        color: #fff;
        text-align: left;
        border-radius: 0.375rem;
        padding: 0.75rem;
        position: absolute;
        z-index: 50;
        left: 150%;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 0.875rem;
        line-height: 1.4;
        white-space: normal;
    }

    .tooltip .tooltiptext::before {
        content: "";
        position: absolute;
        top: 50%;
        right: 100%;
        transform: translateY(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: transparent #4B5563 transparent transparent;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }

    .input-error {
        border-color: #EF4444 !important;
        background-color: #FEF2F2;
    }

    .error-message {
        color: #EF4444;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: none;
        position: absolute;
        bottom: -1.25rem;
        left: 0;
        transition: all 0.2s;
    }

    .label-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 0.25rem;
    }

    .label-left {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .char-count {
        color: #6B7280;
        font-size: 0.75rem;
        transition: color 0.2s;
    }

    .input-error + .char-count {
        color: #EF4444;
    }

    .address-fields {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
        transition: all 0.3s ease-in-out;
    }

    .address-fields.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
        opacity: 1;
        transform: translateY(0);
    }

    .input-group {
        position: relative;
        margin-bottom: 1rem;
    }

    /* Form controls */
    input, select {
        transition: all 0.2s;
    }

    input:focus, select:focus {
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }

    /* Buttons */
    button {
        transition: all 0.2s !important;
    }

    button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    /* Search results dropdown */
    #searchResults {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 0.5rem;
        border-radius: 0.375rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Status message */
    #statusMessage {
        margin-top: 1rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.3s;
    }

    /* Loading overlay */
    #loadingOverlay {
        backdrop-filter: blur(2px);
        transition: opacity 0.3s;
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .compact-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .grid-cols-2, .grid-cols-3 {
            grid-template-columns: 1fr !important;
        }
        
        .w-full.max-w-4xl {
            margin: 0.75rem;
            padding: 1rem;
            max-width: calc(100% - 1.5rem);
            box-sizing: border-box;
        }
        
        .input-group {
            margin-bottom: 0.5rem;
        }
        
        .label-container {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.25rem;
        }
    
        .tooltip .tooltiptext {
            position: absolute;
            min-width: 200px;
            max-width: 260px;
            left: auto;
            right: -10px;
            top: auto;
            bottom: 125%;
            transform: none;
            text-align: left;
            padding: 0.75rem;
            white-space: normal;
            font-size: 0.813rem;
        }
    
        .tooltip .tooltiptext::before {
            top: auto;
            bottom: -12px;
            left: auto;
            right: 10px;
            border-color: #4B5563 transparent transparent transparent;
            border-width: 6px;
        }
    }
    
    /* Responsive typography */
    @media (max-width: 640px) {
        h2 {
            font-size: 1.5rem !important;
        }
        
        .text-sm {
            font-size: 0.813rem !important;
        }
        
        input, select, button {
            font-size: 0.875rem !important;
        }
        
        .tooltip .tooltiptext {
            min-width: 180px;
            max-width: calc(100vw - 60px);
            font-size: 0.75rem;
            right: -5px;
        }
    }
    
    /* Touch device optimizations */
    @media (hover: none) {
        input, select, button {
            min-height: 2.75rem;
        }
        
        .tooltip .tooltiptext {
            display: none;
        }
        
        .tooltip:active .tooltiptext {
            display: block;
            visibility: visible;
            opacity: 1;
        }
    }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div id="loginPage" class="w-full max-w-md bg-white rounded-xl shadow-2xl fade-in p-8 space-y-4" style="display: none;">
        <h2 class="text-3xl font-extrabold text-center text-gray-900">登录</h2>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">用户名</label>
                <input type="text" id="username" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">密码</label>
                <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div class="space-y-2">
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    登录
                </button>
                <a href="mailto:softbizalexander@gmail.com" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-indigo-600 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    联系
                </a>
            </div>
        </form>
        <div id="loginMessage" class="text-center text-sm"></div>
    </div>

    <div id="mainPage" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl fade-in p-6 space-y-2" style="display: none;">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 leading-tight">槟城金刚山牌位系统</h2>
            <button id="logoutBtn" class="px-3 py-1 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out">
                退出
            </button>
        </div>
        <p class="text-sm text-gray-600 -mt-1 mb-4">单个/最后一个：点'生成'，其他的都点'添加'</p>
        <form id="pdfForm" class="space-y-4">
            <div class="compact-form">
                <!-- Search and Name fields -->
                <div class="grid grid-cols-2 gap-4 full-width">
                    <div>
                        <div class="label-container mb-1">
                            <div class="label-left">
                                <label for="search" class="text-sm font-medium text-gray-700">搜索</label>
                                <span class="tooltip">
                                    <i class="fas fa-info-circle text-gray-500"></i>
                                    <span class="tooltiptext">
                                        支持搜索多种内容：<br/>
                                        - 牌位所有文字内容<br/>
                                        - 名字记录<br/>
                                        - 地址信息<br/>
                                        - 历史记录回顾
                                    </span>
                                </span>
                            </div>
                        </div>
                        <input id="search" name="search" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入要搜索的名字记录">
                    </div>
                    <div>
                        <div class="label-container mb-1">
                            <div class="label-left">
                                <label for="name" class="text-sm font-medium text-gray-700">名字记录</label>
                                <span class="tooltiptext">
                                    重要标识信息：<br/>
                                    - 用于日后查询和修改<br/>
                                    - 建议使用易记的名字或编号<br/>
                                    - 可包含中英文和数字
                                </span>
                            </div>
                        </div>
                        <input id="name" name="name" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入名字记录">
                    </div>
                </div>

                <div class="input-group full-width">
                    <select id="searchResults" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" style="display: none;">
                        <option value="">选择搜索结果</option>
                    </select>
                </div>

                <!-- Design Type Selection -->
                <div class="input-group full-width">
                    <div class="label-container mb-1">
                        <div class="label-left">
                            <label for="designType" class="text-sm font-medium text-gray-700">牌位类型</label>
                            <span class="tooltip">
                                <i class="fas fa-info-circle text-gray-500"></i>
                                <span class="tooltiptext">祈福牌位：为在生者祈福<br/>超荐牌位：为已故者超度</span>
                            </span>
                        </div>
                    </div>
                    <select id="designType" name="designType" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="祈福牌位">祈福牌位</option>
                        <option value="超荐牌位">超荐牌位</option>
                    </select>
                </div>
                <!-- 祈福牌位 fields -->
                <div id="qifuFields" class="grid grid-cols-3 gap-4">
                    <div class="input-group">
                        <div class="label-container mb-1">
                            <div class="label-left">
                                <label for="textLeft" class="text-sm font-medium text-gray-700">左 1 排名字</label>
                                <span class="tooltip">
                                    <i class="fas fa-info-circle text-gray-500"></i>
                                    <span class="tooltiptext">12字以内</span>
                                </span>
                            </div>
                            <span class="char-count" id="leftCount">0/12</span>
                        </div>
                        <input id="textLeft" name="textLeft" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入左 1 排名字">
                        <div class="error-message" id="textLeftError"></div>
                    </div>

                    <div class="input-group">
                        <div class="label-container mb-1">
                            <div class="label-left">
                                <label for="qifuMiddle" class="text-sm font-medium text-gray-700">中间 1-2 排名字</label>
                                <span class="tooltip">
                                    <i class="fas fa-info-circle text-gray-500"></i>
                                    <span class="tooltiptext" id="middleTooltip">24字以内</span>
                                </span>
                            </div>
                            <span class="char-count" id="qifuMiddleCount">0/24</span>
                        </div>
                        <input id="qifuMiddle" name="textMiddle" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入中间 1-2 排名字">
                        <div class="error-message" id="qifuMiddleError"></div>
                    </div>

                    <div class="input-group">
                        <div class="label-container mb-1">
                            <div class="label-left">
                                <label for="textRight" class="text-sm font-medium text-gray-700">右 1 排名字</label>
                                <span class="tooltip">
                                    <i class="fas fa-info-circle text-gray-500"></i>
                                    <span class="tooltiptext">12字以内</span>
                                </span>
                            </div>
                            <span class="char-count" id="rightCount">0/12</span>
                        </div>
                        <input id="textRight" name="textRight" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入右 1 排名字">
                        <div class="error-message" id="textRightError"></div>
                    </div>
                </div>

                <!-- 超荐牌位 fields -->
                <div id="chaojianFields" class="address-fields">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <div class="label-container mb-1">
                                <div class="label-left">
                                    <label for="yangshang1" class="text-sm font-medium text-gray-700">阳上1</label>
                                    <span class="tooltiptext">
                                        阳上1说明：<br/>
                                        - 最多28个字<br/>
                                        - 需填写26字以上才能启用阳上2<br/>
                                        - 建议填写完整姓名
                                    </span>
                                </div>
                                <span class="char-count" id="yangshang1Count">0/28</span>
                            </div>
                            <input id="yangshang1" name="yangshang1" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入阳上1">
                            <div class="error-message" id="yangshang1Error"></div>
                        </div>

                        <div class="input-group">
                            <div class="label-container mb-1">
                                <div class="label-left">
                                    <label for="yangshang2" class="text-sm font-medium text-gray-700">阳上2</label>
                                    <span class="tooltiptext">
                                        阳上2说明：<br/>
                                        - 仅在阳上1填写26字以上时可用<br/>
                                        - 最多28个字<br/>
                                        - 可选填写，非必填项
                                    </span>
                                </div>
                                <span class="char-count" id="yangshang2Count">0/28</span>
                            </div>
                            <input id="yangshang2" name="yangshang2" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入阳上2">
                           <div class="error-message" id="yangshang2Error"></div>
                       </div>
                   </div>

                   <div class="grid grid-cols-3 gap-4 mt-4">
                       <div class="input-group">
                           <div class="label-container mb-1">
                               <div class="label-left">
                                   <label for="yiguLeft" class="text-sm font-medium text-gray-700">左侧已故名字</label>
                                   <span class="tooltip">
                                       <i class="fas fa-info-circle text-gray-500"></i>
                                       <span class="tooltiptext">21字以内</span>
                                   </span>
                               </div>
                               <span class="char-count" id="yiguLeftCount">0/21</span>
                           </div>
                           <input id="yiguLeft" name="yiguLeft" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入左侧已故名字">
                           <div class="error-message" id="yiguLeftError"></div>
                       </div>

                       <div class="input-group">
                           <div class="label-container mb-1">
                               <div class="label-left">
                                   <label for="chaojianMiddle" class="text-sm font-medium text-gray-700">回向至</label>
                                   <span class="tooltip">
                                       <i class="fas fa-info-circle text-gray-500"></i>
                                       <span class="tooltiptext">12字以内</span>
                                   </span>
                               </div>
                               <span class="char-count" id="chaojianMiddleCount">0/12</span>
                           </div>
                           <input id="chaojianMiddle" name="textMiddle" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入回向至">
                           <div class="error-message" id="chaojianMiddleError"></div>
                       </div>

                       <div class="input-group">
                           <div class="label-container mb-1">
                               <div class="label-left">
                                   <label for="yiguRight" class="text-sm font-medium text-gray-700">右侧已故名字</label>
                                   <span class="tooltip">
                                       <i class="fas fa-info-circle text-gray-500"></i>
                                       <span class="tooltiptext">21字以内</span>
                                   </span>
                               </div>
                               <span class="char-count" id="yiguRightCount">0/21</span>
                           </div>
                           <input id="yiguRight" name="yiguRight" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入右侧已故名字">
                           <div class="error-message" id="yiguRightError"></div>
                       </div>
                   </div>

                   <div class="grid grid-cols-3 gap-4 mt-4">
                       <div class="input-group">
                           <div class="label-container mb-1">
                               <div class="label-left">
                                   <label for="address1" class="text-sm font-medium text-gray-700">地址1</label>
                                   <span class="tooltip">
                                       <i class="fas fa-info-circle text-gray-500"></i>
                                       <span class="tooltiptext">中文108字/英文177字以内</span>
                                   </span>
                               </div>
                               <span class="char-count" id="address1Count">0/177</span>
                           </div>
                           <input id="address1" name="address1" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入地址1">
                           <div class="error-message" id="address1Error"></div>
                       </div>

                       <div class="input-group">
                           <div class="label-container mb-1">
                               <div class="label-left">
                                   <label for="address2" class="text-sm font-medium text-gray-700">地址2</label>
                                   <span class="tooltip">
                                       <i class="fas fa-info-circle text-gray-500"></i>
                                       <span class="tooltiptext">中文108字/英文177字以内</span>
                                   </span>
                               </div>
                               <span class="char-count" id="address2Count">0/177</span>
                           </div>
                           <input id="address2" name="address2" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入地址2">
                           <div class="error-message" id="address2Error"></div>
                       </div>

                       <div class="input-group">
                           <div class="label-container mb-1">
                               <div class="label-left">
                                   <label for="address3" class="text-sm font-medium text-gray-700">地址3</label>
                                   <span class="tooltip">
                                       <i class="fas fa-info-circle text-gray-500"></i>
                                       <span class="tooltiptext">中文108字/英文177字以内</span>
                                   </span>
                               </div>
                               <span class="char-count" id="address3Count">0/177</span>
                           </div>
                           <input id="address3" name="address3" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="请输入地址3">
                           <div class="error-message" id="address3Error"></div>
                       </div>
                   </div>
               </div>
           </div>

           <!-- Action buttons -->
           <div class="flex flex-col space-y-3">
               <div class="grid grid-cols-2 gap-3">
                   <button type="button" id="addToQueueBtn" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-500 hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-400 transition duration-150 ease-in-out">
                       <span class="flex items-center">
                           <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                               <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                           </svg>
                           <span>添加</span>
                       </span>
                   </button>
                   <button type="button" id="printNowBtn" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition duration-150 ease-in-out">
                       <span class="flex items-center">
                           <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                               <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                           </svg>
                           <span>生成</span>
                       </span>
                   </button>
               </div>
               <a href="mailto:softbizalexander@gmail.com" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 transition duration-150 ease-in-out">
                   有问题可联系
               </a>
           </div>
       </form>
       <div id="statusMessage" class="text-center text-sm"></div>
   </div>

   <script>
    (function() {
        var _0x5f4e3d = "PLACEHOLDER_STRING";
        var _0x2a1b = function(s) {
            return String.fromCharCode.apply(null, s.match(/.{1,2}/g).map(function(c) {
                return parseInt(c, 16);
            }));
        };
        var _0x3c4d = _0x2a1b(_0x5f4e3d);
        var loginForm = document.getElementById('loginForm');
        var loginMessage = document.getElementById('loginMessage');
        var loginPage = document.getElementById('loginPage');
        var mainPage = document.getElementById('mainPage');
        var form = document.getElementById('pdfForm');
        var statusMessage = document.getElementById('statusMessage');
        var addToQueueBtn = document.getElementById('addToQueueBtn');
        var printNowBtn = document.getElementById('printNowBtn');
        var searchInput = document.getElementById('search');
        var searchResults = document.getElementById('searchResults');
        var logoutBtn = document.getElementById('logoutBtn');
        var loadingOverlay = document.getElementById('loadingOverlay');
        var designType = document.getElementById('designType');

        // Field elements
        var textLeft = document.getElementById('textLeft');
        var yangshang1 = document.getElementById('yangshang1');
        var yangshang2 = document.getElementById('yangshang2');
        var qifuMiddle = document.getElementById('qifuMiddle');     // Updated ID
        var chaojianMiddle = document.getElementById('chaojianMiddle'); // New field
        var textRight = document.getElementById('textRight');
        var address1 = document.getElementById('address1');
        var address2 = document.getElementById('address2');
        var address3 = document.getElementById('address3');
        var yiguLeft = document.getElementById('yiguLeft');
        var yiguRight = document.getElementById('yiguRight');

        // Container elements
        var textLeftContainer = document.getElementById('textLeftContainer');
        var yangshang1Container = document.getElementById('yangshang1Container');
        var yangshang2Container = document.getElementById('yangshang2Container');
        var addressFields = document.getElementById('addressFields');
        var qifuFields = document.getElementById('qifuFields');
        var chaojianFields = document.getElementById('chaojianFields');
        var textRightContainer = document.getElementById('textRightContainer');

        // Counter elements
        var leftCount = document.getElementById('leftCount');
        var yangshang1Count = document.getElementById('yangshang1Count');
        var yangshang2Count = document.getElementById('yangshang2Count');
        var qifuMiddleCount = document.getElementById('qifuMiddleCount');       // Updated ID
        var chaojianMiddleCount = document.getElementById('chaojianMiddleCount'); // New counter
        var rightCount = document.getElementById('rightCount');
        var address1Count = document.getElementById('address1Count');
        var address2Count = document.getElementById('address2Count');
        var address3Count = document.getElementById('address3Count');
        var yiguLeftCount = document.getElementById('yiguLeftCount');
        var yiguRightCount = document.getElementById('yiguRightCount');

        function updateFieldsVisibility(type) {
            if (type === '超荐牌位') {
                // Hide 祈福牌位 fields
                qifuFields.style.display = 'none';
                textLeft.required = false;
                textRight.required = false;
                qifuMiddle.required = false;
                chaojianMiddle.required = true;
                
                // Show 超荐牌位 fields
                chaojianFields.classList.add('active');
                addressFields.classList.add('active');
                yangshang1.required = true;
                textRightContainer.style.display = 'none';
                
                // Clear 祈福牌位 fields
                textLeft.value = '';
                qifuMiddle.value = '';
                textRight.value = '';
                updateCharCount(textLeft, leftCount, 12);
                updateCharCount(qifuMiddle, qifuMiddleCount, 24);
                updateCharCount(textRight, rightCount, 12);
                
            } else {
                // Show 祈福牌位 fields
                qifuFields.style.display = 'grid';
                textLeft.required = true;
                textRight.required = true;
                qifuMiddle.required = true;
                chaojianMiddle.required = false;
                
                chaojianFields.classList.remove('active');
                addressFields.classList.remove('active');
                yangshang1.required = false;
                textRightContainer.style.display = 'block';
                
                // Clear 超荐牌位 fields
                yangshang1.value = '';
                yangshang2.value = '';
                chaojianMiddle.value = '';
                address1.value = '';
                address2.value = '';
                address3.value = '';
                yiguLeft.value = '';
                yiguRight.value = '';
                updateCharCount(yangshang1, yangshang1Count, 28);
                updateCharCount(yangshang2, yangshang2Count, 28);
                updateCharCount(chaojianMiddle, chaojianMiddleCount, 12);
                updateCharCount(yiguLeft, yiguLeftCount, 21);
                updateCharCount(yiguRight, yiguRightCount, 21);
                updateAddressCharCount(address1, address1Count);
                updateAddressCharCount(address2, address2Count);
                updateAddressCharCount(address3, address3Count);
            }
            
            validateInputs();
        }

        function updateCharCount(input, countElement, maxLength) {
            const currentLength = input.value.length;
            countElement.textContent = `${currentLength}/${maxLength}`;
        }

        function containsNumbers(text) {
            return /[0-9]/.test(text);
        }
        
        function containsChinese(text) {
            return /[\u4E00-\u9FFF]/.test(text);
        }

        function getAddressMaxLength(text) {
            return containsChinese(text) ? 108 : 177;
        }

        function updateAddressCharCount(input, countElement) {
            const isChinese = containsChinese(input.value);
            const maxLength = isChinese ? 108 : 177;
            const currentLength = input.value.length;
            countElement.textContent = `${currentLength}/${maxLength}`;
            const tooltipElement = countElement.previousElementSibling.querySelector('.tooltiptext');
            if (tooltipElement) {
                tooltipElement.textContent = isChinese ? '108个汉字以内' : '177字符以内';
            }
        }

        // Event listeners for input fields
        textLeft.addEventListener('input', () => updateCharCount(textLeft, leftCount, 12));
        yangshang1.addEventListener('input', function() {
            const maxLength = 28;
            const currentLength = yangshang1.value.length;
            updateCharCount(yangshang1, yangshang1Count, maxLength);
            
            // Enable/disable yangshang2 based on yangshang1 length
            if (currentLength <= 25) { // Changed from 26 to 25 to ensure at least 3 chars are filled
                yangshang2.disabled = true;
                yangshang2.value = '';
                updateCharCount(yangshang2, yangshang2Count, maxLength);
                yangshang2.classList.add('bg-gray-100');
                yangshang2.placeholder = '需要阳上1至少填写26个字';
            } else {
                yangshang2.disabled = false;
                yangshang2.classList.remove('bg-gray-100');
                yangshang2.placeholder = '请输入阳上2';
            }
        });
        yangshang2.addEventListener('input', () => updateCharCount(yangshang2, yangshang2Count, 28));
        qifuMiddle.addEventListener('input', () => updateCharCount(qifuMiddle, qifuMiddleCount, 24));
        chaojianMiddle.addEventListener('input', () => {
            if (containsNumbers(chaojianMiddle.value)) {
                document.getElementById('chaojianMiddleError').textContent = '不能输入数字';
                document.getElementById('chaojianMiddleError').style.display = 'block';
                chaojianMiddle.classList.add('input-error');
                chaojianMiddle.value = chaojianMiddle.value.replace(/[0-9]/g, '');
            } else {
                document.getElementById('chaojianMiddleError').style.display = 'none';
                chaojianMiddle.classList.remove('input-error');
                updateCharCount(chaojianMiddle, chaojianMiddleCount, 12);
            }
        });
        textRight.addEventListener('input', () => updateCharCount(textRight, rightCount, 12));
        address1.addEventListener('input', () => updateAddressCharCount(address1, address1Count));
        address2.addEventListener('input', () => updateAddressCharCount(address2, address2Count));
        address3.addEventListener('input', () => updateAddressCharCount(address3, address3Count));

        yiguLeft.addEventListener('input', () => {
            if (!containsChinese(yiguLeft.value)) {
                document.getElementById('yiguLeftError').textContent = '只能输入中文字符';
                document.getElementById('yiguLeftError').style.display = 'block';
                yiguLeft.classList.add('input-error');
            } else {
                updateCharCount(yiguLeft, yiguLeftCount, 21);
                validateInputLength(yiguLeft, 21, 'yiguLeftError');
            }
        });

        yiguRight.addEventListener('input', () => {
            if (!containsChinese(yiguRight.value)) {
                document.getElementById('yiguRightError').textContent = '只能输入中文字符';
                document.getElementById('yiguRightError').style.display = 'block';
                yiguRight.classList.add('input-error');
            } else {
                updateCharCount(yiguRight, yiguRightCount, 21);
                validateInputLength(yiguRight, 21, 'yiguRightError');
            }
        });

        designType.addEventListener('change', function() {
            updateFieldsVisibility(this.value);
        });

        function validateLeftRightPair() {
            const leftText = textLeft.value.trim();
            const rightText = textRight.value.trim();
            const leftError = document.getElementById('textLeftError');
            const rightError = document.getElementById('textRightError');
            
            if ((leftText && !rightText) || (!leftText && rightText)) {
                const errorMessage = '左右栏文本必须同时填写或同时为空';
                leftError.textContent = errorMessage;
                rightError.textContent = errorMessage;
                leftError.style.display = 'block';
                rightError.style.display = 'block';
                textLeft.classList.add('input-error');
                textRight.classList.add('input-error');
                return false;
            }
            
            leftError.style.display = 'none';
            rightError.style.display = 'none';
            textLeft.classList.remove('input-error');
            textRight.classList.remove('input-error');
            return true;
        }
        
        function validateInputs() {
            const type = designType.value;
            let isValid = true;
        
            function getAddressLimit(text) {
                return containsChinese(text) ? 108 : 177;
            }
        
            if (type === '超荐牌位') {
                isValid = validateInputLength(yangshang1, 28, 'yangshang1Error') && isValid;
                if (yangshang2.value) {
                    isValid = validateInputLength(yangshang2, 28, 'yangshang2Error') && isValid;
                }
                isValid = validateInputLength(chaojianMiddle, 12, 'chaojianMiddleError') && isValid;
        
                if (yiguLeft.value) {
                    if (!containsChinese(yiguLeft.value)) {
                        isValid = false;
                        document.getElementById('yiguLeftError').textContent = '只能输入中文字符';
                        document.getElementById('yiguLeftError').style.display = 'block';
                    } else {
                        isValid = validateInputLength(yiguLeft, 21, 'yiguLeftError') && isValid;
                    }
                }
        
                if (yiguRight.value) {
                    if (!containsChinese(yiguRight.value)) {
                        isValid = false;
                        document.getElementById('yiguRightError').textContent = '只能输入中文字符';
                        document.getElementById('yiguRightError').style.display = 'block';
                    } else {
                        isValid = validateInputLength(yiguRight, 21, 'yiguRightError') && isValid;
                    }
                }
                
                if (address1.value) {
                    isValid = validateInputLength(address1, getAddressLimit(address1.value), 'address1Error') && isValid;
                }
                if (address2.value) {
                    isValid = validateInputLength(address2, getAddressLimit(address2.value), 'address2Error') && isValid;
                }
                if (address3.value) {
                    isValid = validateInputLength(address3, getAddressLimit(address3.value), 'address3Error') && isValid;
                }
            } else {
                isValid = validateLeftRightPair() && isValid;
                isValid = validateInputLength(textLeft, 12, 'textLeftError') && isValid;
                isValid = validateInputLength(qifuMiddle, 24, 'qifuMiddleError') && isValid;
                isValid = validateInputLength(textRight, 12, 'textRightError') && isValid;
            }
        
            return isValid;
        }

        function validateInputLength(input, maxLength, errorId) {
            const errorDiv = document.getElementById(errorId);
            if (input.value.length > maxLength) {
                input.classList.add('input-error');
                errorDiv.style.display = 'block';
                errorDiv.textContent = `超出最大字数限制 (${maxLength})`;
                return false;
            } else {
                input.classList.remove('input-error');
                errorDiv.style.display = 'none';
                return true;
            }
        }

        function showLoadingOverlay() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            loadingOverlay.style.display = 'none';
        }

        function showLoginPage() {
            hideLoadingOverlay();
            loginPage.style.display = 'block';
            mainPage.style.display = 'none';
        }

        function showMainPage() {
            hideLoadingOverlay();
            loginPage.style.display = 'none';
            mainPage.style.display = 'block';
        }

        var token = localStorage.getItem('token');
        if (token) {
            showLoadingOverlay();
            validateToken(token);
        } else {
            showLoginPage();
        }

        function validateToken(token) {
            jsonp(_0x3c4d + '?action=validateToken&token=' + token, function(response) {
                if (response.success) {
                    showMainPage();
                } else {
                    localStorage.removeItem('token');
                    showLoginPage();
                }
            });
        }

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var username = document.getElementById('username').value;
            var password = document.getElementById('password').value;
            jsonp(_0x3c4d + '?action=login&username=' + encodeURIComponent(username) + '&password=' + encodeURIComponent(password), function(response) {
                if (response.success) {
                    localStorage.setItem('token', response.token);
                    showMainPage();
                } else {
                    loginMessage.textContent = '登录失败: ' + response.error;
                    loginMessage.className = 'text-center text-sm text-red-600';
                }
            });
        });

        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('token');
            showLoginPage();
        });

        function setLoading(isLoading) {
           addToQueueBtn.disabled = isLoading;
           printNowBtn.disabled = isLoading;
           if (isLoading) {
               addToQueueBtn.innerHTML = '<span class="flex items-center justify-center"><i class="fas fa-spinner fa-spin loading-icon mr-2"></i><span>处理中...</span></span>';
               printNowBtn.innerHTML = '<span class="flex items-center justify-center"><i class="fas fa-spinner fa-spin loading-icon mr-2"></i><span>处理中...</span></span>';
           } else {
               addToQueueBtn.innerHTML = '<span class="flex items-center justify-center"><svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg><span>添加</span></span>';
               printNowBtn.innerHTML = '<span class="flex items-center justify-center"><svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg><span>生成</span></span>';
           }
       }

       function showStatus(message, isError = false) {
           statusMessage.textContent = message;
           statusMessage.className = isError ? 'mt-3 text-center text-sm text-red-600 fade-in' : 'mt-3 text-center text-sm text-green-600 fade-in';
       }

       function jsonp(url, callback) {
           var callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
           window[callbackName] = function(data) {
               delete window[callbackName];
               document.body.removeChild(script);
               callback(data);
           };
           var script = document.createElement('script');
           script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
           document.body.appendChild(script);
       }

       function submitForm(action) {
           if (!validateInputs()) {
               showStatus('请检查输入字数限制', true);
               return;
           }
           setLoading(true);
           showStatus('');

           var data = {
               action: action,
               token: localStorage.getItem('token'),
               name: document.getElementById('name').value,
               designType: document.getElementById('designType').value
           };

           if (designType.value === '超荐牌位') {
               data.yangshang1 = yangshang1.value || '';
               data.yangshang2 = yangshang2.value || '';
               data.textMiddle = chaojianMiddle.value;  // Use the correct field
               data.address1 = address1.value || '';
               data.address2 = address2.value || '';
               data.address3 = address3.value || '';
               data.yiguLeft = yiguLeft.value || '';
               data.yiguRight = yiguRight.value || '';
           } else {
               data.textLeft = textLeft.value || '';
               data.textMiddle = qifuMiddle.value;  // Use the correct field
               data.textRight = textRight.value || '';
           }

           var queryString = Object.keys(data).map(key => key + '=' + encodeURIComponent(data[key])).join('&');

           jsonp(_0x3c4d + '?' + queryString, function(response) {
               if (response.success) {
                   showStatus(response.message);
                   if (response.pdfBase64) {
                       try {
                           var byteCharacters = atob(response.pdfBase64);
                           var byteNumbers = new Array(byteCharacters.length);
                           for (var i = 0; i < byteCharacters.length; i++) {
                               byteNumbers[i] = byteCharacters.charCodeAt(i);
                           }
                           var byteArray = new Uint8Array(byteNumbers);
                           var blob = new Blob([byteArray], {type: 'application/pdf'});
                           var blobUrl = URL.createObjectURL(blob);
                           
                           if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                               var link = document.createElement('a');
                               link.href = blobUrl;
                               link.download = '祈福牌.pdf';
                               link.click();
                           } else {
                               window.open(blobUrl, '_blank');
                           }
                       } catch (error) {
                           console.error("Error creating PDF blob:", error);
                           showStatus('创建 PDF 时出错: ' + error.message, true);
                       }
                   }
               } else {
                   if (response.error === 'Invalid or expired token') {
                       localStorage.removeItem('token');
                       showLoginPage();
                   }
                   showStatus('发生错误: ' + (response.error || '未知错误'), true);
               }
               setLoading(false);
           });
       }

       function fillForm(result) {
           // First clear the form
           document.getElementById('name').value = '';
           yangshang1.value = '';
           yangshang2.value = '';
           textLeft.value = '';
           qifuMiddle.value = '';
           chaojianMiddle.value = '';
           textRight.value = '';
           address1.value = '';
           address2.value = '';
           address3.value = '';
           yiguLeft.value = '';
           yiguRight.value = '';

           // Set name first
           document.getElementById('name').value = result.name || '';

           // Set design type and trigger its change event
           if (result.designType) {
               designType.value = result.designType;
               const event = new Event('change', { bubbles: true });
               designType.dispatchEvent(event);
           }

           // Wait for design type change to complete
           setTimeout(() => {
               if (result.designType === '超荐牌位') {
                   yangshang1.value = result.yangshang1 || '';
                   yangshang2.value = result.yangshang2 || '';
                   chaojianMiddle.value = result.textMiddle || '';  // Use correct field
                   address1.value = result.address1 || '';
                   address2.value = result.address2 || '';
                   address3.value = result.address3 || '';
                   yiguLeft.value = result.yiguLeft || '';
                   yiguRight.value = result.yiguRight || '';
                   
                   // Update character counters
                   updateCharCount(yangshang1, yangshang1Count, 28);
                   updateCharCount(yangshang2, yangshang2Count, 28);
                   updateCharCount(chaojianMiddle, chaojianMiddleCount, 12);
                   updateCharCount(yiguLeft, yiguLeftCount, 21);
                   updateCharCount(yiguRight, yiguRightCount, 21);
                   updateAddressCharCount(address1, address1Count);
                   updateAddressCharCount(address2, address2Count);
                   updateAddressCharCount(address3, address3Count);
               } else {
                   textLeft.value = result.textLeft || '';
                   qifuMiddle.value = result.textMiddle || '';  // Use correct field
                   textRight.value = result.textRight || '';
                   
                   // Update character counters
                   updateCharCount(textLeft, leftCount, 12);
                   updateCharCount(qifuMiddle, qifuMiddleCount, 24);
                   updateCharCount(textRight, rightCount, 12);
               }

               validateInputs();
           }, 0);
       }

       function searchSheet() {
    var searchTerm = searchInput.value.trim();
    
    // Always clear the search results dropdown first
    searchResults.innerHTML = '<option value="">选择搜索结果</option>';
    searchResults.style.display = 'none';
    
    if (searchTerm.length > 0) {
        jsonp(_0x3c4d + '?action=search&term=' + encodeURIComponent(searchTerm) + '&token=' + localStorage.getItem('token'), function(response) {
            // Clear again before processing new results to prevent any race conditions
            searchResults.innerHTML = '<option value="">选择搜索结果</option>';
            
            if (response.success && response.results && Array.isArray(response.results)) {
                // Additional client-side filtering for extra safety
                const filteredResults = response.results.filter(result => {
                    const searchTermLower = searchTerm.toLowerCase();
                    
                    // Function to safely check if a field contains the search term
                    function hasSearchTerm(field) {
                        // Convert null/undefined to empty string
                        field = field || '';
                        // Convert to string if it's not already
                        field = field.toString();
                        // Only proceed if field is not empty after trimming
                        if (field.trim() === '') return false;
                        
                        // Convert to lowercase for case-insensitive comparison
                        field = field.toLowerCase();
                        
                        // For exact string inclusion check
                        return field.indexOf(searchTermLower) !== -1;
                    }

                    // Check each field individually
                    return (
                        hasSearchTerm(result.name) ||
                        hasSearchTerm(result.textLeft) ||
                        hasSearchTerm(result.yangshang1) ||
                        hasSearchTerm(result.yangshang2) ||
                        hasSearchTerm(result.textMiddle) ||
                        hasSearchTerm(result.textRight) ||
                        hasSearchTerm(result.address1) ||
                        hasSearchTerm(result.address2) ||
                        hasSearchTerm(result.address3) ||
                        hasSearchTerm(result.yiguLeft) ||
                        hasSearchTerm(result.yiguRight)
                    );
                });

                if (filteredResults.length > 0) {
                    filteredResults.forEach(result => {
                        var option = document.createElement('option');
                        option.value = JSON.stringify(result);
                        option.textContent = `${result.name} (${result.displayText}, ${result.date})`;
                        searchResults.appendChild(option);
                    });
                    searchResults.style.display = 'block';
                } else {
                    showStatus('没有找到匹配的记录', true);
                    searchResults.style.display = 'none';
                }
            } else {
                if (response.error === 'Invalid or expired token') {
                    localStorage.removeItem('token');
                    showLoginPage();
                } else {
                    showStatus('搜索失败: ' + (response.error || '未知错误'), true);
                }
                searchResults.style.display = 'none';
            }
        });
    } else {
        // Clear status when search term is empty
        showStatus('');
    }
}

// Search input event listener
searchInput.addEventListener('input', function(e) {
    if (!e.target.value.trim()) {
        searchResults.innerHTML = '<option value="">选择搜索结果</option>';
        searchResults.style.display = 'none';
        showStatus('');
    } else {
        searchSheet(); // Call searchSheet when there is input
    }
});

// Search results selection handler
searchResults.addEventListener('change', function() {
    var selectedValue = searchResults.value;
    if (selectedValue) {
        fillForm(JSON.parse(selectedValue));
    }
});

// Action button event listeners
addToQueueBtn.addEventListener('click', function() {
    submitForm('addToQueue');
});

printNowBtn.addEventListener('click', function() {
    submitForm('printNow');
});

// Other event listeners
textLeft.addEventListener('input', validateLeftRightPair);
textRight.addEventListener('input', validateLeftRightPair);

// Initialize form state
updateFieldsVisibility(designType.value);

})();
</script>
</body>
</html>
